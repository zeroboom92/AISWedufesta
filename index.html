<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>체험 스탬프</title>
<style>
  :root { --maxw: 540px; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
         max-width: var(--maxw); margin: 0 auto; padding: 0 14px 24px; background: #ffffff; color: #111; }
  header { margin: 0 calc(50vw - min(50vw, var(--maxw)/2)); }
  .banner { width: 100vw; max-width: 100%; height: auto; display: block; object-fit: cover; }
  h1 { font-size: 20px; margin: 16px 0 8px; }
  .notice { background: #f6f7f9; padding: 12px; border-radius: 10px; line-height: 1.5; }
  .board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 16px 0; }
  .slot { border: 2px dashed #bbb; border-radius: 14px; aspect-ratio: 1/1;
          display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; background:#fafafa; }
  .filled { border-style: solid; background: #fff; }
  .btnbar { display:flex; gap:8px; margin-top:10px; }
  button { padding: 12px; border: 0; border-radius: 12px; font-weight: 700; cursor: pointer; background:#efefef; flex:1; }
  .primary { background: #d6f5d6; }
  .danger { background: #ffe1e1; }
  .muted { font-size:12px; opacity:.7; margin-top:8px; }
  .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
           background: rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius: 10px; font-size:14px; display:none; }
</style>
</head>
<body>
  <!-- 상단 배너 -->
  <header>
    <img id="banner" class="banner" alt="행사 배너" />
  </header>

  <main style="padding-top:12px;">
    <h1>체험 스탬프</h1>

    <div id="progress" class="notice">불러오는 중…</div>
    <div id="board" class="board"></div>

    <div class="btnbar">
      <button id="redeem" class="primary">간식 수령하기</button>
      <button id="resetAll" class="danger">전체 초기화</button>
    </div>
    <div class="muted">※ 같은 부스 QR은 중복으로 찍히지 않습니다(같은 기기 기준).</div>
  </main>

  <div id="toast" class="toast"></div>

<script>
  // ===== 설정값 =====
  const BANNER_URL = "https://images.unsplash.com/photo-1514511547117-f9c4a0b6a1f7?q=80&w=1600&auto=format&fit=crop"; // 행사 배너 이미지 URL로 교체
  const SET_SIZE   = 5;            // 5개 채우면 보상
  const MAX_SLOTS  = 10;           // 화면에 보여줄 칸 수(원하면 5로 줄여도 됨)
  const ADMIN_PASS = "0425";       // 관리자 비밀번호(현장 운영용, 소스에 노출되는 점 유의)

  // ===== 저장 키 =====
  const STORAGE_SCANNED   = "qr_stamp_scanned_booths"; // Set(JSON 배열)
  const STORAGE_REDEEMED  = "qr_stamp_redeemed_count"; // 정수(수령 횟수)

  // ===== 요소 =====
  const $banner    = document.querySelector("#banner");
  const $board     = document.querySelector("#board");
  const $progress  = document.querySelector("#progress");
  const $redeem    = document.querySelector("#redeem");
  const $resetAll  = document.querySelector("#resetAll");
  const $toast     = document.querySelector("#toast");

  // ===== 초기 상태 =====
  $banner.src = BANNER_URL;

  const PARAMS = new URLSearchParams(location.search);
  const boothParam = PARAMS.get("booth"); // 예: A01, B02 …

  const scanned = new Set(JSON.parse(localStorage.getItem(STORAGE_SCANNED) || "[]"));
  let redeemedCount = parseInt(localStorage.getItem(STORAGE_REDEEMED) || "0", 10);

  // ===== 유틸 =====
  function save() {
    localStorage.setItem(STORAGE_SCANNED, JSON.stringify([...scanned]));
    localStorage.setItem(STORAGE_REDEEMED, String(redeemedCount));
  }

  function stampsInCurrentCycle() {
    // 현재 사이클의 도장 수 = 총 스캔 수 - (수령 횟수 * 5), 0~5로 클램프
    const total = scanned.size;
    const done  = redeemedCount * SET_SIZE;
    return Math.max(0, Math.min(SET_SIZE, total - done));
  }

  function showToast(msg) {
    $toast.textContent = msg;
    $toast.style.display = "block";
    setTimeout(() => $toast.style.display = "none", 1400);
  }

  function render() {
    const inCycle = stampsInCurrentCycle();
    const total   = scanned.size;

    $board.innerHTML = "";
    for (let i = 0; i < MAX_SLOTS; i++) {
      const div = document.createElement("div");
      div.className = "slot" + (i < inCycle ? " filled" : "");
      div.textContent = i < inCycle ? "★" : "·";
      $board.appendChild(div);
    }

    $progress.innerHTML = `
      <b>이번 세트</b>: ${inCycle}/${SET_SIZE}개 &nbsp; | &nbsp; 
      <b>누적 도장</b>: ${total}개 &nbsp; | &nbsp; 
      <b>수령 완료</b>: ${redeemedCount}회
    `;

    // 5개 미만이면 수령 버튼 비활성화 느낌 주기(필수는 아님)
    $redeem.disabled = inCycle < SET_SIZE;
    $redeem.style.opacity = inCycle < SET_SIZE ? 0.6 : 1;
  }

  function tryStamp(boothCode) {
    if (!boothCode) { render(); return; }
    const key = String(boothCode).trim().toUpperCase();

    if (scanned.has(key)) {
      showToast("이미 찍은 QR입니다.");
      render();
      return;
    }

    scanned.add(key);
    save();
    render();

    if (stampsInCurrentCycle() >= SET_SIZE) {
      // 5개 채워졌지만, 이제는 자동 진행하지 않고 '간식 수령하기'로 처리
      showToast("5개 달성! 간식 수령하기 버튼을 눌러주세요.");
    } else {
      showToast("도장을 추가했어요!");
    }
  }

  // ===== 버튼 동작 =====
  $redeem.onclick = () => {
    if (stampsInCurrentCycle() < SET_SIZE) {
      showToast("아직 도장이 부족합니다.");
      return;
    }
    const pwd = prompt("관리자 비밀번호를 입력하세요.");
    if (pwd === null) return; // 취소
    if (pwd !== ADMIN_PASS) {
      alert("비밀번호가 올바르지 않습니다.");
      return;
    }
    // 수령 처리: 세트 하나 차감 → 다음 세트 대기
    redeemedCount += 1;
    save();
    render();
    alert("수령 처리되었습니다. 다음 세트를 시작하세요!");
  };

  $resetAll.onclick = () => {
    if (!confirm("전체 초기화할까요? (모든 기록 삭제)")) return;
    localStorage.removeItem(STORAGE_SCANNED);
    localStorage.removeItem(STORAGE_REDEEMED);
    location.reload();
  };

  // ===== 시작 =====
  render();
  tryStamp(boothParam);
</script>
</body>
</html>
