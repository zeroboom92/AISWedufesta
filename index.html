<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
<title></title>
<style>
  :root { --maxw: 540px; }

  /* 배경 끊김 최소화: html에 그라데이션, body는 투명 */
  html { height: 100%; background: linear-gradient(to bottom, #E8A3C5, #9B80EC); }
  body {
    font-family: 'Nanum Gothic', system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
    max-width: var(--maxw); margin: 0 auto; padding: 0 20px 24px; background: transparent; color: #333;
  }

  header, footer { margin: 0 calc(50vw - min(50vw, var(--maxw)/2)); }
  .banner { width: 100vw; max-width: 100%; height: auto; display: block; object-fit: cover; }
  .banner-bottom { width: 100vw; max-width: 100%; height: auto; display: block; object-fit: cover; margin-top: 20px; }

  /* 안내 박스들 */
  .notice {
    background: rgba(255,255,255,0.8); padding: 20px; border-radius: 12px; line-height: 1.4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; font-size: 16px; font-weight: 500;
  }
  .survey {
    background: rgba(66,133,244,0.8); color:#fff; padding:20px; border-radius:12px; line-height:1.4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15); margin-bottom:20px; text-align:center; font-size:16px; font-weight:600;
  }

  /* 스탬프 보드 */
  .board-wrap { position: relative; }               /* ← 캐릭터 절대배치 기준 */
  .board {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;
    max-width: 400px; margin-left: auto; margin-right: auto;
  }
  .slot {
    border: 0; border-radius: 50%; aspect-ratio: 1/1; min-height: 100px;
    background: #ffffff center/70% no-repeat url("./stamp_empty.png"); /* 크기 복원 */
    box-shadow: 0 0 0 3px #e9ecef inset;
  }
  .filled { background: #ffffff center/85% no-repeat url("./stamp_filled.png"); box-shadow: none; }
  .filled::before { content: none; }

  /* 캐릭터: 보드 내부 절대배치(3번째 아래 + 5번째 오른쪽) */
  #character {
    position: absolute; width: 110px; opacity: .95; pointer-events: none;
    transition: transform .2s ease, opacity .2s ease;
  }
  @media (max-width: 500px) {
    #character { width: 90px; }
  }

  button { padding: 16px; border: 0; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 16px;
           transition: all 0.2s; width: 100%; margin-top: 14px; }
  .primary { background: #4285f4; color: white; }
  .primary:hover { background: #3367d6; }
  .muted { font-size: 12px; opacity: 0.6; margin-top: 12px; text-align: center; }
  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
           background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 20px; font-size: 14px; display: none; }
</style>
</head>
<body>
  <!-- 상단 배너 -->
  <header>
    <img id="banner" class="banner" alt="행사 배너" />
  </header>

  <main style="padding-top:12px;">
    <div id="progress" class="notice">불러오는 중…</div>
    <div class="survey">운영본부에서 만족도조사 하고<br>기념품 받아가세요!</div>

    <!-- 스탬프 보드 + 캐릭터 -->
    <div class="board-wrap">
      <div id="board" class="board"></div>
      <img id="character" src="./character_idle.png" alt="캐릭터">
    </div>

    <button id="redeem" class="primary">간식 수령하기</button>
    <div class="muted">※ 같은 부스 QR은 중복으로 찍히지 않습니다(같은 기기 기준).</div>
  </main>

  <!-- (선택) 하단 배너: 파일이 없으면 이 섹션 통째로 지워도 됩니다 -->
  <footer>
    <img src="./banner-bottom.png" alt="행사 하단 배너" class="banner banner-bottom" loading="lazy" />
  </footer>

  <div id="toast" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== 설정값 =====
  const BANNER_URL = "./banner3.png";
  const SET_SIZE   = 5;
  const MAX_SLOTS  = 5;
  const ADMIN_PASS = "0425";

  // ===== 저장 키 =====
  const STORAGE_SCANNED   = "qr_stamp_scanned_booths";
  const STORAGE_REDEEMED  = "qr_stamp_redeemed_count";

  // ===== 요소 =====
  const $banner    = document.querySelector("#banner");
  const $board     = document.querySelector("#board");
  const $progress  = document.querySelector("#progress");
  const $redeem    = document.querySelector("#redeem");
  const $toast     = document.querySelector("#toast");
  const $character = document.querySelector("#character");

  if ($banner) $banner.src = BANNER_URL;

  const PARAMS = new URLSearchParams(location.search);
  const boothParam = PARAMS.get("booth");

  const scanned = new Set(JSON.parse(localStorage.getItem(STORAGE_SCANNED) || "[]"));
  let redeemedCount = parseInt(localStorage.getItem(STORAGE_REDEEMED) || "0", 10);

  // ===== 유틸 =====
  function save() {
    localStorage.setItem(STORAGE_SCANNED, JSON.stringify([...scanned]));
    localStorage.setItem(STORAGE_REDEEMED, String(redeemedCount));
  }
  function stampsInCurrentCycle() {
    const total = scanned.size;
    const done  = redeemedCount * SET_SIZE;
    return Math.max(0, Math.min(SET_SIZE, total - done));
  }
  function showToast(msg) {
    if (!$toast) return;
    $toast.textContent = msg;
    $toast.style.display = "block";
    setTimeout(() => $toast.style.display = "none", 1400);
  }

  // 캐릭터 위치 계산: 3번째(아래) + 5번째(오른쪽)
  function positionCharacter() {
    if (!$character) return;
    const slots = $board.querySelectorAll(".slot");
    if (slots.length < 5) return;

    const r3 = slots[2].getBoundingClientRect();
    const r5 = slots[4].getBoundingClientRect();
    const wrap = $board.getBoundingClientRect(); // board 영역 기준

    const top  = (r3.bottom - wrap.top) + 16;   // 3번째 아래쪽 여백
    const left = (r5.right  - wrap.left) + 24;  // 5번째 오른쪽 여백

    $character.style.top  = `${top}px`;
    $character.style.left = `${left}px`;
  }

  function render() {
    const inCycle = stampsInCurrentCycle();
    const remaining = SET_SIZE - inCycle;

    // 보드 렌더
    $board.innerHTML = "";
    for (let i = 0; i < MAX_SLOTS; i++) {
      const div = document.createElement("div");
      div.className = "slot" + (i < inCycle ? " filled" : "");
      $board.appendChild(div);
    }

    // 진행 안내
    if (remaining > 0) {
      $progress.innerHTML = `
        <span style="font-size: 25px; color: #4285f4; font-weight: 700;">${remaining}</span>개의 QR코드를 더 모으고<br>
        운영본부에 와서 간식꾸러미를 받으세요
      `;
    } else {
      $progress.innerHTML = `
        <span style="color: #4285f4; font-weight: 700; font-size: 18px;">축하합니다!</span><br>
        운영본부에 와서<br>
        간식꾸러미를 받으세요
      `;
    }

    // 캐릭터 상태(이미지 전환)
    if ($character) {
      $character.src = inCycle >= SET_SIZE ? "./character_happy.png" : "./character_idle.png";
    }

    // 슬롯 생성 후 위치 계산
    positionCharacter();
  }

  function tryStamp(boothCode) {
    render();                       // 먼저 보드 표시
    if (!boothCode) return;         // 파라미터 없으면 종료

    const key = String(boothCode).trim().toUpperCase();
    if (scanned.has(key)) { showToast("이미 찍은 QR입니다."); return; }

    scanned.add(key);
    save();
    render();

    if (stampsInCurrentCycle() >= SET_SIZE) showToast("5개 달성! 운영본부로 가세요.");
    else showToast("도장을 추가했어요!");
  }

  // 간식 수령(완전 초기화)
  if ($redeem) {
    $redeem.onclick = () => {
      if (stampsInCurrentCycle() < SET_SIZE) { showToast("아직 도장이 부족합니다."); return; }
      const pwd = prompt("관리자 비밀번호를 입력하세요."); if (pwd === null) return;
      if (pwd !== ADMIN_PASS) { alert("비밀번호가 올바르지 않습니다."); return; }

      scanned.clear();
      redeemedCount = 0;
      save();
      render();
      alert("수령 처리 및 전체 기록이 초기화되었습니다. 새로운 세트를 시작하세요!");
    };
  }

  // 시작
  render();
  tryStamp(boothParam);

  // ✅ Safari(iPhone)에서 캐시된 페이지 복귀 시에도 QR 처리 재실행
function processTokenFromURL() {
  const params = new URLSearchParams(location.search);
  const token = params.get("token") || params.get("booth");
  if (token) tryStamp(token);
}

// 페이지가 캐시에서 복귀될 때 (bfcache)
window.addEventListener("pageshow", (event) => {
  if (event.persisted) processTokenFromURL();
});

// 탭이 다시 보일 때 (백그라운드 → 포그라운드)
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) processTokenFromURL();
});

  
  // 창 크기 변경 시 재배치
  window.addEventListener("resize", positionCharacter);
});

// 전역 에러 표시(문제 파악용)
window.addEventListener('error', (e) => {
  const box = document.getElementById('progress');
  if (box) box.innerText = '스크립트 오류: ' + e.message;
});
</script>
</body>
</html>


