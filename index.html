<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR ìŠ¤íƒ¬í”„</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif; max-width: 540px; margin: 24px auto; padding: 0 14px; }
  header { display:flex; justify-content: space-between; align-items:center; }
  h1 { font-size: 20px; margin: 0; }
  .tag { font-size: 12px; opacity: .7; }
  .board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 16px 0; }
  .slot { border: 2px dashed #bbb; border-radius: 14px; aspect-ratio: 1/1;
          display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; background:#fafafa; }
  .filled { border-style: solid; background: #fff; }
  .notice { background: #f6f7f9; padding: 12px; border-radius: 10px; line-height: 1.4; }
  .btnbar { display:flex; gap:8px; margin-top:10px; }
  button { padding: 12px; border: 0; border-radius: 12px; font-weight: 700; cursor: pointer; background:#efefef; }
  .ok { background: #d6f5d6; }
  .warn { background: #ffe9c9; }
  .muted { font-size:12px; opacity:.7; margin-top:8px; }
  .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
           background: rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius: 10px; font-size:14px; display:none; }
</style>
</head>
<body>
  <header>
    <h1>ì²´í—˜ ìŠ¤íƒ¬í”„</h1>
    <div class="tag" id="roundTag">ë¼ìš´ë“œ 1</div>
  </header>

  <div id="progress" class="notice">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
  <div id="board" class="board"></div>

  <div class="btnbar">
    <button id="reset5" class="ok">ë‹¤ìŒ 5ê°œ ì„¸íŠ¸ ì‹œì‘</button>
    <button id="resetAll" class="warn">ì „ì²´ ì´ˆê¸°í™”</button>
  </div>
  <div class="muted">â€» ê°™ì€ ë¶€ìŠ¤ QRì€ ì¤‘ë³µìœ¼ë¡œ ì°íˆì§€ ì•ŠìŠµë‹ˆë‹¤(ê°™ì€ ê¸°ê¸° ê¸°ì¤€).</div>

  <div id="toast" class="toast"></div>

<script>
  // ===== ì„¤ì • =====
  const SET_SIZE = 5;          // 5ê°œ ì±„ìš°ë©´ ë³´ìƒ
  const MAX_SLOTS = 10;        // í™”ë©´ì— ë³´ì—¬ì¤„ ì¹¸ ìˆ˜ (ì›í•˜ë©´ 5ë¡œ ì¤„ì—¬ë„ ë¨)
  const STORAGE_KEY = "qr_stamp_scanned_booths";  // ìŠ¤ìº”í•œ ë¶€ìŠ¤ ëª©ë¡(Set ì €ì¥)
  const STORAGE_ROUNDS = "qr_stamp_round";        // ëª‡ ë²ˆì§¸ 5ì„¸íŠ¸ì¸ì§€(0ë¶€í„° ì‹œì‘)

  // ===== ìš”ì†Œ =====
  const $board = document.querySelector("#board");
  const $progress = document.querySelector("#progress");
  const $reset5 = document.querySelector("#reset5");
  const $resetAll = document.querySelector("#resetAll");
  const $roundTag = document.querySelector("#roundTag");
  const $toast = document.querySelector("#toast");

  // ===== ìƒíƒœ =====
  const PARAMS = new URLSearchParams(location.search);
  const booth = PARAMS.get("booth"); // ì˜ˆ: A01, B02 â€¦
  const scanned = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));
  let round = parseInt(localStorage.getItem(STORAGE_ROUNDS) || "0", 10);

  function showToast(msg) {
    $toast.textContent = msg;
    $toast.style.display = "block";
    setTimeout(() => $toast.style.display = "none", 1400);
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify([...scanned]));
    localStorage.setItem(STORAGE_ROUNDS, String(round));
  }

  function currentRoundCount() {
    const total = scanned.size;
    const doneBefore = round * SET_SIZE;
    return Math.max(0, Math.min(SET_SIZE, total - doneBefore));
  }

  function paintRoundTag() {
    $roundTag.textContent = `ë¼ìš´ë“œ ${round + 1}`;
  }

  function renderBoard() {
    $board.innerHTML = "";
    const filled = currentRoundCount();
    for (let i = 0; i < MAX_SLOTS; i++) {
      const div = document.createElement("div");
      div.className = "slot" + (i < filled ? " filled" : "");
      div.textContent = i < filled ? "â˜…" : "Â·";
      $board.appendChild(div);
    }
    const total = scanned.size;
    $progress.innerHTML = `
      <b>ì´ë²ˆ ë¼ìš´ë“œ</b>: ${filled}/${SET_SIZE}ê°œ &nbsp; | &nbsp; <b>ëˆ„ì </b>: ${total}ê°œ
    `;
    paintRoundTag();
  }

  function tryStamp(boothCode) {
    if (!boothCode) { renderBoard(); return; }
    const key = String(boothCode).trim().toUpperCase();

    if (scanned.has(key)) {
      showToast("ì´ë¯¸ ì°ì€ QRì…ë‹ˆë‹¤.");
      renderBoard();
      return;
    }
    scanned.add(key);
    save();
    const cnt = currentRoundCount();
    renderBoard();

    if (cnt >= SET_SIZE) {
      setTimeout(() => {
        alert("ì¶•í•˜í•©ë‹ˆë‹¤! 5ê°œ ë‹¬ì„± ğŸ‰ ì§ì›ì—ê²Œ ë³´ì—¬ì£¼ì„¸ìš”.");
        // ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì´ë™(ëˆ„ì ì€ ìœ ì§€)
        round += 1;
        save();
        renderBoard();
      }, 50);
    } else {
      showToast("ë„ì¥ì„ ì¶”ê°€í–ˆì–´ìš”!");
    }
  }

  // ë²„íŠ¼
  $reset5.onclick = () => {
    round += 1; save(); renderBoard();
    showToast("ë‹¤ìŒ 5ê°œ ì„¸íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!");
  };

  $resetAll.onclick = () => {
    if (!confirm("ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”? (ëª¨ë“  ê¸°ë¡ ì‚­ì œ)")) return;
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_ROUNDS);
    location.reload();
  };

  // ì‹œì‘
  renderBoard();
  tryStamp(booth);
</script>
</body>
</html>
