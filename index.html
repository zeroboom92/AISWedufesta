<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 리워드 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #334155;
            padding: 1rem;
        }
        .container {
            max-width: 42rem;
            width: 100%;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05), 0 6px 6px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            text-align: center;
            transition: transform 0.3s ease-in-out;
        }
        .container:hover {
            transform: translateY(-5px);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 90%;
        }
        .modal-button {
            margin-top: 1rem;
            padding: 0.75rem 2rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .text-blue-600 {
            color: #2563EB;
        }
        .text-green-600 {
            color: #16A34A;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="container mx-auto p-8 bg-white rounded-3xl shadow-lg border border-gray-200">
    <div class="space-y-6">
        <h1 class="text-4xl font-extrabold text-gray-800">QR 리워드 이벤트</h1>
        <p id="status-message" class="text-gray-600 text-lg">QR 코드 스캔 중...</p>
        <div class="bg-gray-100 p-6 rounded-2xl border border-gray-200 shadow-inner">
            <h2 class="text-2xl font-bold text-gray-700 mb-2">현재 누적 스캔 수</h2>
            <div class="flex justify-center items-center">
                <span id="scan-count" class="text-6xl font-bold text-blue-600 transition-all duration-500 ease-out">0</span>
                <span class="text-4xl font-light text-gray-400"> / 5</span>
            </div>
        </div>
        <p id="reward-message" class="text-green-600 font-bold text-xl hidden">축하합니다! 5개의 QR코드를 모두 스캔했습니다. 운영본부에서 리워드를 받아가세요!</p>
        <button id="reward-button" class="mt-8 w-full py-4 px-6 bg-blue-600 text-white font-bold text-xl rounded-full shadow-md transition-all duration-300 hover:bg-blue-700 hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 hidden">
            리워드 받기
        </button>
    </div>
</div>

<script>
    // QR코드를 스캔했을 때 넘겨받는 QR ID를 URL에서 가져옵니다.
    const urlParams = new URLSearchParams(window.location.search);
    const qrId = urlParams.get('qr_id');

    const statusMessage = document.getElementById('status-message');
    const scanCount = document.getElementById('scan-count');
    const rewardMessage = document.getElementById('reward-message');
    const rewardButton = document.getElementById('reward-button');
    const rewardGoal = 5; // 목표 스캔 횟수
    const modalId = 'my-modal'; // 모달 ID

    // 1. 사용자 ID 생성 또는 가져오기
    // 로컬 스토리지에서 사용자 ID가 있는지 확인합니다.
    let userId = localStorage.getItem('userId');
    if (!userId) {
        // 사용자 ID가 없으면 새로운 ID를 생성하고 로컬 스토리지에 저장합니다.
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
        console.log(\"새로운 사용자 ID 생성: \", userId);
    } else {
        console.log(\"기존 사용자 ID: \", userId);
    }

    // 2. Firebase Cloud Function으로 데이터 전송 및 응답 받기
    // 여기에 당신의 Firebase Cloud Function URL을 입력하세요.
    const firebaseFunctionURL = 'https://console.firebase.google.com/project/aisw-edu-festa/overview';
    
    // QR ID가 유효한지 확인합니다.
    if (!qrId) {
        statusMessage.textContent = '올바른 QR코드가 아닙니다.';
        console.error(\"QR ID가 URL에 없습니다.\");
    } else {
        statusMessage.textContent = '스캔 기록을 확인 중입니다...';

        // Firebase Cloud Function으로 POST 요청을 보냅니다.
        // CORS 문제를 해결하기 위해 POST 요청을 사용합니다.
        fetch(firebaseFunctionURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                qr_id: qrId
            }),
        })
        .then(response => {
            if (!response.ok) {
                // 응답이 성공적이지 않으면 오류를 throw합니다.
                throw new Error('네트워크 응답이 실패했습니다.');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // 성공적으로 응답을 받았을 때 UI를 업데이트합니다.
                if (data.is_new_scan) {
                    statusMessage.textContent = '새로운 QR코드를 스캔했습니다!';
                } else {
                    statusMessage.textContent = '이미 스캔한 QR코드입니다.';
                }
                scanCount.textContent = data.total_scans;

                // 목표 횟수에 도달했는지 확인합니다.
                if (data.total_scans >= rewardGoal) {
                    rewardMessage.classList.remove('hidden');
                    rewardButton.classList.remove('hidden');
                    statusMessage.textContent = '축하합니다!';
                }

            } else {
                // 오류가 발생했을 때 메시지를 표시합니다.
                statusMessage.textContent = `오류: ${data.message}`;
                console.error('Firebase Cloud Function에서 오류가 발생했습니다:', data.message);
            }
        })
        .catch(error => {
            // 네트워크 오류 또는 기타 예외를 처리합니다.
            statusMessage.textContent = '네트워크 오류가 발생했습니다. 다시 시도해 주세요.';
            console.error('Fetch 오류:', error);
        });
    }

    // 커스텀 모달 창을 생성하는 함수
    function showModal(message) {
        let modal = document.getElementById(modalId);
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <p>${message}</p>
                    <button class="modal-button">확인</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.modal-button').addEventListener('click', () => {
                modal.remove();
            });
        }
    }

    // 리워드 받기 버튼 클릭 이벤트 핸들러
    rewardButton.addEventListener('click', () => {
        const authKey = `${userId}-${rewardGoal}`; // 간단한 인증 키 생성
        showModal(`리워드 수령을 위해 이 화면을 운영본부에 보여주세요.<br>인증번호: **${authKey}**`);
    });
</script>
</body>
</html>
